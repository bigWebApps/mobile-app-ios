<!DOCTYPE html>
<html>
<head>
    <title>HelpDesk</title>
    <meta name="viewport"
          content="width=device-width, initial-scale=1, minimum-scale=1, maximum-scale=1, user-scalable=no">
    <meta name="format-detection" content="telephone=no">

    <link rel="stylesheet" href="css/jquery.mobile-1.1.0.min.css"/>
    <link rel="stylesheet" type="text/css" href="css/helpdesk-base.css">
    <link rel="stylesheet" type="text/css" href="css/HelpDesk.css">
	<script src="phonegap.js"></script>
	<script src="js/jquery.min.js"></script>
    <script src="js/jquery.mobile-1.1.0.min.js"></script>
    <script src="js/HelpDeskAPI.js"></script>
    <script src="js/helper.js"></script>
	
    <script>
        // this is what is required for the on the mobile page load
        pageInit(function(event){

            var login = localStorage.getItem('login');

            var pass = localStorage.getItem('password');

            var result, selected_org, selected_inst;

            var parseorgs = function (data) {
                if (!data)
                {
                    window.location.replace("login.html");
                    return;
                }

                result = data;

                $.each(data, function (index, org) {
                    //Add after the default val
                    $("#orgs option:eq(0)").after("<option value='" + org.Key + "'>" + org.Name + "</option>");
                    $("#orgs").show();
                    $("#login").hide();

                });
            }

            if (!login || !pass)
            {
                window.location.replace("login.html");
            }
            else
            {

                api = new HelpDeskAPI(login, pass);
                console.log(api);
                api.organizations([],parseorgs);
            }

            var parseinsts = function (org_key) {
                if (!result) {
                    $("#login").show();
                    return;
                }

                var org_index;
                $.each(result, function (index, org) {
                    //Add after the default val
                    if (org.Key == org_key)
                    {
                        org_index = index;
                        return;
                    }

                });
                console.log(org_index);
                var data = result[org_index].Instances;

                $.each(data, function (index, inst) {
                    //Add after the default val
                    $("#insts option:eq(0)").after("<option value='" + inst.Key + "'>" + inst.Name + "</option>");
                    $("#orgs").hide();
                    $("#insts").show();
                });
            }

            var set_org = function () {
                console.log(2);
                api.instances([],parseinsts);
            }

            var set_inst = function () {
                console.log(1);
                $.mobile.changePage("home.html");
            }

            $("#orgs").change(function () {
                $("#orgs option:selected").each(function () {
                    var org_key = $(this).val();
                    if (org_key != 0) {
                        console.log(org_key);
                        selected_org = org_key;
                        parseinsts(org_key)
                    }
                });
            })
                    .change();
            $("#insts").change(function () {
                $("#insts option:selected").each(function () {
                    var inst_key = $(this).val();
                    if (inst_key != 0) {
                        selected_inst = inst_key;
                        $("#insts").hide();
                        $("#home").show();
                    }
                });
            })
            .change();
        });
    </script>

</head>
<body>

<div data-role="page">

    <div data-role="header" data-position="fixed" data-theme="h">
        <h1>HelpDesk</h1>
    </div>
    <!-- /header -->

    <div id="content" data-role="content">
        <a href="login.html" id="login" data-role="button" data-transition="flip" data-theme="g" data-iconpos="right"
           data-icon="arrow-r">Login to HelpDesk</a>
        <a style="display:none" id="home" href="home.html" data-role="button" data-transition="flip" data-theme="g"
           data-iconpos="right" data-icon="arrow-r">Home View</a>
        <select style="display:none" name="select-organization" id="orgs" data-role="none">
            <option value="0">-- Select Organization --</option>
        </select>
        <select style="display:none" name="select-instance" id="insts" data-role="none">
            <option value="0">-- Select Instance --</option>
        </select>        
    </div>
    <!-- /content -->
    
</div>
<!-- /page -->

</body>
</html>