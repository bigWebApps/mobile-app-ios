<!DOCTYPE html> 
<html> 
	<head> 
	<title>HelpDesk</title>
        <meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1, maximum-scale=1, user-scalable=no">
        <meta name="format-detection" content="telephone=no">
        <link rel="stylesheet" href="css/jquery.mobile-1.1.0.min.css"/>
        <link rel="stylesheet" type="text/css" href="css/helpdesk-base.css">
        <link rel="stylesheet" type="text/css" href="css/HelpDesk.css">
        <script src="js/jquery.min.js"></script>
        <script src="js/jquery.mobile-1.1.0.min.js"></script>
        <script src="js/moment.min.js"></script>
        <script src="js/jquery.md5.min.js"></script>
        <script src="js/jquery.url.js"></script>
        <script src="js/handlebars-1.0.0.beta.6.js"></script>
        <script src="js/HelpDeskAPI.js"></script>
        <script src="js/templates.js"></script>
        <script src="js/helpdesk.js"></script>
    </head>
    <body>
    <input id="ticketUserId" type="hidden"/>
    <input id="ticketMakeMeUserId" type="hidden"/>
    <input id="ticketMakeMeUserName" type="hidden"/>
    <div id="container"/>
<div id="create_ticket_page" data-role="page">
	<div data-role="content" data-theme="d">
        <script>
            function Event(){
                this.eventHandlers = new Array();
            }

            Event.prototype.addHandler = function(eventHandler){
                this.eventHandlers.push(eventHandler);
            }

            Event.prototype.execute = function(args){

                for(var i = 0; i < this.eventHandlers.length; i++){
                    this.eventHandlers[i](args);
                }
            }

            //create event
            myHandler = new Event();

            function create_ticket_submit() {
                var subject = htmlEscape($('#subject').val().trim());
                var details = htmlEscape($('#details').val().trim());
                if (!subject)
                {
                    tooltip('Please enter Subject!');
                    return false;
                }
                else if (subject.length > 100)
                {
                    tooltip('Subject should be less 100 chars!');
                    return false;
                }
                else if (details.length > 5000)
                {
                    tooltip('Details should be less 5000 chars!');
                    return false;
                }
                else
                {
                    var ticket = {};
                    ticket["TechnicianId"] = $("#tech_list").val();
                    ticket["UserId"] = $("#ticketUserId").val();
                    ticket["AccountId"] = $("#account_list").val();
                    ticket["Subject"] = subject;
                    ticket["InitialPost"] = details;

                    /*
                    //Not defined yet
                    ticket["AccountLocationId"] = 0;
                    ticket["LocationId"] = 0;
                    ticket["ClassId"] = 0;
                    ticket["Level"] = 0;
                    ticket["SubmissionCategory"] = "";
                    ticket["IsHandleByCallCentre"] = false;
                    ticket["CreationCategoryId"] = 0;
                    ticket["PriorityId"] = 0;
                    ticket["SerialNumber"] = 0;
                    ticket["IDMethod"] = 0;
                    ticket["CustomFieldsXML"] = 0;
                    ticket["TicketStatus"] = 0;
                    ticket["ProjectId"] = 0;
                    ticket["FolderId"] = 0;
                    ticket["EstimatedTime"] = 0;
                    */

                    //console.log(ticket);
                api.ticket_create({"Ticket": ticket,"OrganizationKey": getStorage("organization"),"InstanceKey": getStorage("instance"), "NoteText": "", "Password":$('#password').val()}, create_ticket_postback);
                }

                //todo: need to check when Id initialized notification
                if ($("#transfer_me_alternate").is(":checked"))
                {
                    myHandler.addHandler(attachAltTech_ticket_submit);
                }
                else
                    attachAltTech_ticket_submit ();

                return false;
            }

            var id;
            var ticketNumber;

            function create_ticket_postback (data)
            {
                //$(".submitButton").removeAttr("disabled");
                if (data)
                {
                    id= data.Id;
                    ticketNumber = data.TicketNumber;
                    tooltip("Ticket #" + ticketNumber + " created successfully!");
                    $('#subject').val('');
                    $('#details').val('');
                    setTimeout(myHandler.execute(), 2000);
                    return false;
                }
                else
                    alert("Error!");
                return false;
            }

            function attachAltTech_ticket_submit ()
            {
                if ($("#transfer_me_alternate").is(":checked"))
                {
                    api.attachAltTech_ticket({"TransferToTechId":$("#ticketUserId").val(),"Id": id,"OrganizationKey": getStorage("organization"),"InstanceKey": getStorage("instance"), "NoteText": "", "Password":$('#password').val()}, attachAltTech_ticket_postback);
                }
                else
                    attachAltTech_ticket_postback({data:1});
                return false;
            }

            function attachAltTech_ticket_postback (data)
            {
                if (data)
                {
                    $.mobile.changePage("home.html");
                }
                else
                    alert("Error!");
                return false;
            }
        </script>
    	<div align="center" style="margin-bottom: 30px;"><img src="img/helpdesk_logo.png"></div>		
		<form data-ajax="false" onsubmit="return create_ticket_submit();">

            <input type="text" id="select_customer_name" value="" placeholder="Customer"/>
            <ul id="select_customer_list" data-role="listview" data-inset="true"></ul>
            <br>
			<select id="account_list" data-role="none">
			</select>
            <script id="ht_account_list" type="text/x-handlebars-template">
                {{#each this}}
                <option value="{{Id}}">{{Name}}</option>
                {{/each}}
            </script>
                <br>
            <select id="tech_list" data-role="none">
            </select>
            <script id="ht_tech_list" type="text/x-handlebars-template">
                {{#each this}}
                <option value="{{Id}}">{{FirstName}} {{LastName}}</option>
                {{/each}}
            </script>
         		<br>
            	<label><input type="checkbox" id="transfer_me_alternate" /> Make me the alternate </label>
                <br>              
				<input type="text" name="subject" id="subject" value="" placeholder="Subject"/>
				<br>
				<textarea name="details" id="details" placeholder="Details"></textarea>
				
                <a href="home.html" data-role="button" data-inline="true">Cancel</a>
				
                <button type="submit" data-theme="b" data-inline="true" name="submit" value="submit-value" >
					Submit Ticket
				</button>
                
                
                	
			</form>
	</div><!-- /content -->



</div><!-- /page -->

</body>
</html>